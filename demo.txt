================
GPUs on GKE Demo
================

# User Guide: https://docs.google.com/document/d/1hYOqaOVSu68ZaUsmCKwyP6kf6UtlTMiE_hxoJ2uUqvs/edit

# Start the cluster
# --accelerators is only available in the alpha surface of gcloud.
# accelerators are only supported on alpha clusters of GKE.
# We require cluster versions 1.7.x or later.
    gcloud alpha container clusters create \
        --enable-kubernetes-alpha \
        --accelerator=type=nvidia-tesla-k80,count=2 \
        --zone=us-west1-b \
        --cluster-version=1.7.2 \
            gpu-cluster-1


# Install the drivers
# This restarts the nodes. Takes around 10m for the installation to finish.
    kubectl create -f https://raw.githubusercontent.com/ContainerEngine/accelerators/master/cos-nvidia-gpu-installer/daemonset.yaml


# Make sure GPUs are available
    kubectl get nodes -o yaml | grep -E 'hostname:|nvidia-gpu'

-----------------------------------------------------------

# Start the tensorflow job with CPUs
kubectl create -f tensorflow-cpu/cpu-job.yaml

# Check that the job is finished
kubectl get all

# Start the tensorflow job with GPUs
kubectl create -f tensorflow-gpu/gpu-job.yaml

# Check that the job is finished
kubectl get all

# See the results
kubectl logs jobs/tensorflow-cpu | tail -25
kubectl logs jobs/tensorflow-gpu | tail -25

# Cleanup
kubectl delete jobs/tensorflow-cpu jobs/tensorflow-gpu

# List of files
find . | grep -v git

# Only the tensorflow package is different
git diff --no-index ./tensorflow-cpu/Dockerfile ./tensorflow-gpu/Dockerfile

# No difference in the tensorflow program
git diff --no-index ./tensorflow-cpu/matmul.py ./tensorflow-gpu/matmul.py

# Important differences
git diff --no-index ./tensorflow-cpu/cpu-job.yaml ./tensorflow-gpu/gpu-job.yaml

-----------------------------------------------------------

# Delete the cluster
    gcloud container clusters delete gpu-cluster-1 --zone us-west1-b
